<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Music Queue</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
    img.loading {
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 100;
      }
    </style>
  </head>
  <body>
    <div id="search-div"></div>

    <script src="https://fb.me/react-15.0.0.js"></script>
    <script src="https://fb.me/react-dom-15.0.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/babel">
      var Search = React.createClass({
        getInitialState: function() {
          return { tracks: [], isLoading: false, view: 'search', queue: [] };
        },
        onClick: function(event) {
          this.setState({isLoading: true, view: 'search'});
          event.preventDefault();
          $.get('/api/search', {q: $('#query').val()}, this.success, 'json');
        },
        success: function(data) {
          var results = [];
          for(var i in data) {
            results.push({fulltitle: data[i].fulltitle, thumbnail: data[i].thumbnail, id: data[i].id});
          }
          this.setState({ tracks: results, isLoading: false });
        },
        enqueue: function(event) {
          $.get('/api/play/' + event.target.dataset.id + '?img=' + event.target.dataset.img, null, this.enqueueSuccess);
        },
        enqueueSuccess: function() {
          this.setState({view: 'confirm'});
        },
        queue: function() {
          $.get('/api/queue', null, this.queueSuccess, 'json');
        },
        queueSuccess: function(data) {
          this.setState({view: 'queue', queue: data});
        },
        dequeue: function(event) {
          $.get('/tracks/' + event.target.dataset.id + '/remove', null, this.dequeueSuccess);
        },
        dequeueSuccess: function(event) {
          this.queue();
        },
        render: function() {
          let searchResults = [];
          for(var i in this.state.tracks) {
            searchResults.push(
              <li key={i}>
                <img data-id={this.state.tracks[i].id} width='50' src={this.state.tracks[i].thumbnail}/>
                <span>{this.state.tracks[i].fulltitle}</span> 
                <input data-id={this.state.tracks[i].id} 
		  data-name={this.state.tracks[i].fulltitle}
                  data-img={this.state.tracks[i].thumbnail}
                  type="button" 
                  value="Add to queue" 
                  onClick={this.enqueue}/>
              </li>
            );
          }
          let centered=true;
          let loadingGif;
          if (this.state.isLoading) {
            loadingGif = (
              <img
                src="/loading.svg"
                responsive
                className="loading centered"
              />
            );
          }
          let resultsView;
          if (this.state.view === 'search') {
            resultsView =
              <div>
                Search Results
                {loadingGif}
                <ul>
                  {searchResults}
                </ul>
              </div>;
          } else if (this.state.view === 'confirm'){
            resultsView =
              <div>Queued</div>;
          } else {
            let queueResults = [];
            for(var i in this.state.queue) {
              queueResults.push(
                <li key={i} style={{listStyle: 'none'}}>
                  <img width='50' src={this.state.queue[i].img}/>
                  <span>{this.state.queue[i].fulltitle}</span> 
                  <input data-id={this.state.queue[i].id} type="button" value="Remove" onClick={this.dequeue}/>
                </li>
              );
            }
            resultsView = queueResults;
          }

          return (
            <div>
              <div>
                <label for="query">Enter Search Term</label>
                <form onSubmit={this.onClick}>
                  <input id="query" type="text" className="form-control" style={{width: '50%'}}/>
                </form>
                <input type="button" className="btn btn-primary" value="Search" onClick={this.onClick}/>
                <input type="button" className="btn" value="Queue" onClick={this.queue}/>
              </div>
              {resultsView}
            </div>
          )
        }
      });

      ReactDOM.render(
        <Search />,
        $('#search-div')[0]
      );
    </script>
  </body>
</html>
